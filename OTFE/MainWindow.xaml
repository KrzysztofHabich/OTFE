<Window x:Class="OTFE.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:OTFE"
        xmlns:vm="clr-namespace:OTFE.ViewModels"
        xmlns:controls="clr-namespace:OTFE.Controls"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=vm:MainWindowViewModel}"
        Title="OTFE - OpenTelemetry File Explorer" 
        Height="800" Width="1400"
        WindowStartupLocation="CenterScreen">
    
    <Window.InputBindings>
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding OpenFilesCommand}" />
        <KeyBinding Key="F" Modifiers="Ctrl" Command="{Binding SearchCommand}" />
        <KeyBinding Key="Down" Modifiers="Alt" Command="{Binding SelectNextTraceCommand}" />
        <KeyBinding Key="Up" Modifiers="Alt" Command="{Binding SelectPreviousTraceCommand}" />
    </Window.InputBindings>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Menu Bar -->
        <Menu Grid.Row="0">
            <MenuItem Header="_File">
                <MenuItem Header="_Open Files..." Command="{Binding OpenFilesCommand}" InputGestureText="Ctrl+O"/>
                <MenuItem Header="Open _Folder..." Command="{Binding OpenFolderCommand}"/>
                <Separator/>
                <MenuItem Header="_Clear All" Command="{Binding ClearFilesCommand}"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="Exit_Click"/>
            </MenuItem>
        </Menu>
        
        <!-- Main Content -->
        <Grid Grid.Row="1" Margin="4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="150"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="300" MinWidth="200"/>
            </Grid.ColumnDefinitions>
            
            <!-- Left Panel: Files and Traces -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="120" MinHeight="80"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- Loaded Files Header -->
                <Grid Grid.Row="0" Margin="4,4,4,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="Loaded Files" FontWeight="Bold"/>
                    <Button Grid.Column="1" Content="Clear Selection" Padding="4,1" FontSize="10"
                            Command="{Binding ClearFileSelectionCommand}"
                            Visibility="{Binding HasFileSelection, Converter={StaticResource BoolToVisibilityConverter}}"
                            ToolTip="Show traces from all files"/>
                </Grid>
                
                <!-- Loaded Files List -->
                <ListBox Grid.Row="1" 
                         x:Name="LoadedFilesListBox"
                         ItemsSource="{Binding LoadedFiles}"
                         SelectionMode="Extended"
                         SelectionChanged="LoadedFilesListBox_SelectionChanged"
                         Margin="4"
                         BorderThickness="1"
                         BorderBrush="Gray">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding FileName}" ToolTip="{Binding FilePath}"/>
                                <TextBlock Text=" (" Foreground="Gray"/>
                                <TextBlock Text="{Binding SpanCount}" Foreground="Gray"/>
                                <TextBlock Text=" spans)" Foreground="Gray"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                
                <!-- Search Section -->
                <StackPanel Grid.Row="2" Margin="4">
                    <TextBlock Text="Search" FontWeight="Bold" Margin="0,0,0,4"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" 
                                 Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                                 ToolTip="Examples: HasError AND Name:GET, Status:Error, Duration>500ms&#x0a;Use AND to combine conditions">
                            <TextBox.InputBindings>
                                <KeyBinding Key="Return" Command="{Binding SearchCommand}"/>
                                <KeyBinding Key="Escape" Command="{Binding ClearSearchCommand}"/>
                            </TextBox.InputBindings>
                        </TextBox>
                        <Button Grid.Column="1" Content="✕" Width="24" Margin="2,0,0,0"
                                Command="{Binding ClearSearchCommand}" ToolTip="Clear search"/>
                    </Grid>
                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                        <Button Content="Errors" Padding="8,2" Margin="0,0,4,0"
                                Command="{Binding FilterErrorsCommand}" ToolTip="Show only traces with errors (HasError)"/>
                        <Button Content="Slow" Padding="8,2" Margin="0,0,4,0"
                                Command="{Binding FilterSlowTracesCommand}" ToolTip="Show traces > 500ms"/>
                        <Button Content="Anomalies" Padding="8,2" 
                                Command="{Binding FilterAnomaliesCommand}" 
                                ToolTip="Show ML-detected anomalies (HasAnomalies)"
                                Visibility="{Binding AnomalyCount, Converter={StaticResource IntToVisibilityConverter}}"/>
                    </StackPanel>
                </StackPanel>
                
                <!-- Sort Section -->
                <StackPanel Grid.Row="3" Margin="4">
                    <TextBlock Text="Sort by" FontWeight="Bold" Margin="0,4,0,4"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ComboBox Grid.Column="0" 
                                  ItemsSource="{Binding SortOptions}"
                                  SelectedItem="{Binding SelectedSortOption}"/>
                        <ToggleButton Grid.Column="1" Width="24" Margin="2,0,0,0"
                                      IsChecked="{Binding SortDescending}"
                                      ToolTip="Toggle ascending/descending">
                            <TextBlock Text="↓" FontWeight="Bold"/>
                        </ToggleButton>
                    </Grid>
                </StackPanel>
                
                <!-- Traces Header -->
                <TextBlock Grid.Row="4" Text="Traces" FontWeight="Bold" Margin="4"/>
                
                <!-- Traces List -->
                <ListBox Grid.Row="5" 
                         ItemsSource="{Binding Traces}"
                         SelectedItem="{Binding SelectedTrace}"
                         Margin="4"
                         BorderThickness="1"
                         BorderBrush="Gray"
                         VirtualizingStackPanel.IsVirtualizing="True"
                         VirtualizingStackPanel.VirtualizationMode="Recycling">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <!-- Status indicator bar -->
                                <Rectangle Grid.Column="0" Grid.RowSpan="2" 
                                           Width="4" Margin="0,2"
                                           Fill="{Binding Status, Converter={StaticResource StatusToBrushConverter}}"
                                           RadiusX="2" RadiusY="2"/>
                                
                                <TextBlock Grid.Row="0" Grid.Column="1" 
                                           Text="{Binding EntryPoint}" 
                                           FontWeight="SemiBold" 
                                           Margin="4,0,0,0"
                                           TextTrimming="CharacterEllipsis"/>
                                <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Margin="4,0,0,0">
                                    <TextBlock Text="{Binding TotalDuration.TotalMilliseconds, StringFormat={}{0:F2}ms}" 
                                               Foreground="DarkBlue" Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding SpanCount}" Foreground="Gray"/>
                                    <TextBlock Text=" spans" Foreground="Gray"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
            
            <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch" 
                          Background="LightGray" Cursor="SizeWE"/>
            
            <!-- Center Panel: Gantt Chart -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <TextBlock Grid.Row="0" Text="Trace Timeline" FontWeight="Bold" Margin="4"/>
                
                <Border Grid.Row="1" BorderThickness="1" BorderBrush="Gray" Margin="4" Background="White">
                    <controls:GanttChartControl 
                        Trace="{Binding SelectedTrace}"
                        SelectedSpan="{Binding SelectedSpan, Mode=TwoWay}"
                        SpanSelected="GanttChart_SpanSelected"/>
                </Border>
            </Grid>
            
            <GridSplitter Grid.Column="3" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch" 
                          Background="LightGray" Cursor="SizeWE"/>
            
            <!-- Right Panel: Span Details -->
            <Grid Grid.Column="4">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <TextBlock Grid.Row="0" Text="Span Details" FontWeight="Bold" Margin="4"/>
                
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="4">
                    <StackPanel>
                        <TextBlock Text="No span selected" 
                                   Foreground="Gray"
                                   Visibility="{Binding SelectedSpan, Converter={StaticResource NullToVisibilityConverter}, TargetNullValue=Visible, FallbackValue=Visible}"/>
                        
                        <!-- Span details -->
                        <StackPanel Visibility="{Binding SelectedSpan, Converter={StaticResource NotNullToVisibilityConverter}, FallbackValue=Collapsed}">
                            <!-- Basic Info -->
                            <Border Background="#F5F5F5" Padding="8" Margin="0,0,0,8" CornerRadius="4">
                                <StackPanel>
                                    <TextBlock Text="{Binding SelectedSpan.Name}" FontWeight="Bold" FontSize="14" TextWrapping="Wrap"/>
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                        <TextBlock Text="{Binding SelectedSpan.Status, Converter={StaticResource StatusToTextConverter}}" 
                                                   Foreground="{Binding SelectedSpan.Status, Converter={StaticResource StatusToBrushConverter}}"
                                                   FontWeight="SemiBold"/>
                                        <TextBlock Text=" • " Foreground="Gray"/>
                                        <TextBlock Text="{Binding SelectedSpan.Duration.TotalMilliseconds, StringFormat={}{0:F2}ms}" Foreground="DarkBlue"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                            
                            <!-- IDs Section -->
                            <TextBlock Text="Identifiers" FontWeight="SemiBold" Margin="0,4,0,4"/>
                            <Grid Margin="0,0,0,8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Trace ID:" Foreground="Gray"/>
                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedSpan.TraceId}" FontFamily="Consolas" FontSize="11"/>
                                
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Span ID:" Foreground="Gray"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedSpan.SpanId}" FontFamily="Consolas" FontSize="11"/>
                                
                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Parent ID:" Foreground="Gray"/>
                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedSpan.ParentId}" FontFamily="Consolas" FontSize="11"/>
                            </Grid>
                            
                            <!-- Tags Section -->
                            <TextBlock Text="Tags" FontWeight="SemiBold" Margin="0,4,0,4"/>
                            <ItemsControl ItemsSource="{Binding SelectedSpan.Tags}" Margin="0,0,0,8">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" MaxWidth="120"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding Key}" Foreground="Gray" 
                                                       TextTrimming="CharacterEllipsis" ToolTip="{Binding Key}"/>
                                            <TextBlock Grid.Column="1" Text="{Binding Value}" Margin="8,0,0,0" 
                                                       TextWrapping="Wrap" FontFamily="Consolas" FontSize="11"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            
                            <!-- Anomalies Section -->
                            <StackPanel Visibility="{Binding CurrentSpanAnomalies.Count, Converter={StaticResource IntToVisibilityConverter}}">
                                <TextBlock Text="⚠️ Anomalies Detected" FontWeight="SemiBold" Foreground="OrangeRed" Margin="0,4,0,4"/>
                                <ItemsControl ItemsSource="{Binding CurrentSpanAnomalies}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#FFF3E0" BorderBrush="Orange" BorderThickness="1" 
                                                    Padding="8" Margin="0,0,0,4" CornerRadius="4">
                                                <StackPanel>
                                                    <TextBlock Text="{Binding AnomalyType}" FontWeight="SemiBold" Foreground="OrangeRed"/>
                                                    <TextBlock Text="{Binding Description}" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                        <TextBlock Text="Severity: " Foreground="Gray"/>
                                                        <TextBlock Text="{Binding Severity, StringFormat='{}{0:P0}'}" FontWeight="SemiBold"/>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                            
                            <!-- Events Section -->
                            <TextBlock Text="Events" FontWeight="SemiBold" Margin="0,4,0,4"/>
                            <ItemsControl ItemsSource="{Binding SelectedSpan.Events}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#FFF8E1" Padding="8" Margin="0,0,0,4" CornerRadius="4">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss.fff}'}" 
                                                           Foreground="Gray" FontSize="11"/>
                                                <ItemsControl ItemsSource="{Binding Attributes}" Margin="0,4,0,0">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <StackPanel Margin="0,2">
                                                                <TextBlock Text="{Binding Key}" Foreground="Gray" FontSize="11"/>
                                                                <TextBlock Text="{Binding Value}" FontFamily="Consolas" FontSize="11" 
                                                                           TextWrapping="Wrap" MaxHeight="100"/>
                                                            </StackPanel>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>
        
        <!-- Status Bar -->
        <StatusBar Grid.Row="2">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>
            <StatusBarItem>
                <ProgressBar Width="100" Height="16" IsIndeterminate="True" 
                             Visibility="{Binding IsAnalyzingAnomalies, Converter={StaticResource BoolToVisibilityConverter}}"
                             ToolTip="Analyzing for anomalies..."/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <ProgressBar Width="100" Height="16" IsIndeterminate="{Binding IsLoading}" 
                             Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
